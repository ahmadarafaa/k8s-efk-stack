# Local EFK Stack Testbed

Fast local development environment for testing EFK configurations using kind + docker-compose.

## Quick Start

```bash
chmod +x make.sh && ./make.sh up && ./make.sh status
```

## Access

- **Elasticsearch**: http://localhost:9200 (elastic:changeme)
- **Kibana**: http://localhost:5601 (elastic:changeme)

## Usage

### Commands
```bash
./make.sh up      # Start everything
./make.sh status  # Check status
./make.sh down    # Clean teardown
```

### Kibana Setup
1. Open http://localhost:5601
2. Login with `elastic:changeme`
3. Go to Stack Management â†’ Index Patterns
4. Create index pattern: `k8s-logs*`
5. Select `@timestamp` as time field
6. View logs in Discover

### Environment Variables
```bash
export ELASTICSEARCH_USERNAME=elastic
export ELASTIC_PASSWORD=mypassword
./make.sh up
```

## Architecture

- **kind**: Single-node Kubernetes cluster (efk-lab)
- **docker-compose**: Elasticsearch 8.x + Kibana with auth
- **Fluentd**: DaemonSet collecting `/var/log/containers/*.log`
- **Connectivity**: Prefers `host.docker.internal`, falls back to headless service

## Troubleshooting

### No logs in Elasticsearch
```bash
kubectl logs -n logging -l k8s-app=fluentd-logging
curl -u elastic:changeme 'http://localhost:9200/_cat/indices?v'
```

### Connectivity issues
- Check `kubectl get pods -A` for fluentd pod status
- Verify ES container IP: `docker inspect $(docker compose ps -q elasticsearch)`
- Test from pod: `kubectl run debug --rm -i --image=busybox -- wget -O- http://host.docker.internal:9200`

### Auth failures
- Verify credentials in docker-compose.yml
- Check ES logs: `docker compose logs elasticsearch`

## Switching Configurations

To test different Fluentd/Fluent Bit configs:
1. Modify `fluentd-bit-configmap-working.yaml`
2. Update host/credentials in output section
3. Run `kubectl apply -f fluentd-configmap-local.yaml` (generated by make.sh)
4. Restart: `kubectl rollout restart daemonset/fluentd -n logging`

## Files Generated

- `fluentd-configmap-local.yaml`: Patched version with local ES settings
- External service/endpoints (if host.docker.internal fails)